<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">


<extension engine="1.0">
	<id>fancy_spoiler</id>
	<title>Spoiler BBcode</title>
	<version>0.5.27</version>
	<description>Add BBcode tag «spoiler»</description>
	<author>dimka.linux@gmail.com</author>

	<minversion>1.4RC1</minversion>
	<maxtestedon>1.4RC2</maxtestedon>


	<hooks>
		<!-- -->
		<hook id="pun_bbcode_pre_tags_merge"><![CDATA[
			$tags_without_attr[] = 'spoiler';
		]]></hook>


		<!-- -->
		<hook id="ps_preparse_tags_start"><![CDATA[
			$tags_block[] = 'spoiler';
		]]></hook>


		<!-- -->
		<hook id="ps_preparse_bbcode_start"><![CDATA[
			$tags[] = 'spoiler';
			$tags_opened[] = 'spoiler';
			$tags_closed[] = 'spoiler';
			$tags_fix[] = 'spoiler';
		]]></hook>


		<!-- -->
		<hook id="ps_do_bbcode_replace"><![CDATA[
			global $lang_fancy_spoiler;
			if (!isset($lang_fancy_spoiler)) {
				if ($forum_user['language'] != 'English' && file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/lang.php')) {
					include $ext_info['path'].'/lang/'.$forum_user['language'].'/lang.php';
				} else {
					include $ext_info['path'].'/lang/English/lang.php';
				}
			}

			$pattern[] = '#\[spoiler\](.*?)\[/spoiler\]#s';
			$replace[] = '</p><p class="visual-hidden fancy_spoiler_switcher"><span class="js_link" data-lang-open="'.$lang_fancy_spoiler["spoiler_open"].'" data-lang-close="'.$lang_fancy_spoiler["spoiler_close"].'">'.$lang_fancy_spoiler["spoiler_open"].'</span></p><div class="fancy_spoiler">$1</div><p>';
		]]></hook>


		<!-- -->
		<hook id="hd_head"><![CDATA[
			if (defined('FORUM_PAGE')) {
				if (in_array(FORUM_PAGE, array('news', 'postdelete', 'modtopic', 'post', 'viewtopic', 'searchposts', 'pun_pm-inbox', 'pun_pm-outbox', 'postedit'))) {
					$forum_loader->add_css('.fancy_spoiler { display: none; padding: .35em 0; }',	array('type' => 'inline', 'media' => 'screen'));
					$forum_loader->add_css('.fancy_spoiler { display: block; } .fancy_spoiler_switcher { display: none; }', array('type' => 'inline', 'media' => 'screen', 'noscript' => true));

					// Use inline JS for small scripts
					$forum_loader->add_js('PUNBB.fancy_spoiler=(function(){function b(c){return(c.offsetWidth!==0);}function a(c){return function(){var d=c.nextSibling,e=c.firstChild;if(d&&PUNBB.common.hasClass(d,"fancy_spoiler")){if(!b(d)){d.style.display="block";e.innerHTML=e.getAttribute("data-lang-close");}else{d.style.display="none";e.innerHTML=e.getAttribute("data-lang-open");}return false;}return true;};}return{init:function(){var c=PUNBB.common.arrayOfMatched(function(d){return(PUNBB.common.hasClass(d,"fancy_spoiler_switcher"));},document.getElementsByTagName("p"));PUNBB.common.map(function(d){console.log(d);d.onclick=a(d);PUNBB.common.removeClass(d,"visual-hidden");},c);}};}());PUNBB.common.addDOMReadyEvent(PUNBB.fancy_spoiler.init);', array('type' => 'inline'));
				}
			}
		]]></hook>


		<!-- pun_bbcode - add button -->
		<hook id="pun_bbcode_pre_buttons_output"><![CDATA[
			$this->add_button(array('name'	=> 'fancy_spoiler', 'title' => 'spoiler', 'tag' => 'spoiler', 'image' => true));
		]]></hook>

		<!-- pun_bbcode - add styles for button -->
		<hook id="pun_bbcode_styles_loaded"><![CDATA[
			if ($forum_user['pun_bbcode_use_buttons'] == '1') {
				if ($forum_user['style'] != 'Oxygen' && file_exists($ext_info['path'].'/css/'.$forum_user['style'].'/fancy_spoiler.min.css')) {
					$forum_loader->add_css($ext_info['url'].'/css/'.$forum_user['style'].'/fancy_spoiler.min.css', array('type' => 'url', 'media' => 'screen'));
				} else {
					// Optimize: inline for Oxygen
					$forum_loader->add_css('#pun_bbcode_bar #pun_bbcode_button_fancy_spoiler.image { background: url("'.$ext_info['url'].'/css/Oxygen/img/spoiler.png") 50% 50% no-repeat; } .fancy_spoiler_switcher { display: inline-block; }', array('type' => 'inline'));
				}
			}
		]]></hook>
	</hooks>
</extension>
